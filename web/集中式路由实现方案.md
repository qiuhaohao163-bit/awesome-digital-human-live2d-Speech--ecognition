# Next.js 集中式路由实现方案

## 1. 当前项目路由现状

当前项目使用 **Next.js App Router**（基于文件系统的路由），路由结构如下：

```
app/
├── (products)/          # 路由组
│   └── sentio/         # /sentio 路由
│       ├── page.tsx    # /sentio 页面
│       └── settings.tsx # /sentio/settings 页面
├── login/              # /login 路由
│   └── page.tsx        # /login 页面
├── layout.tsx          # 根布局
└── page.tsx            # / 主页（重定向到 /sentio）
```

## 2. 集中式路由需求分析

用户希望实现类似 Vue Router 的集中式路由管理，具有以下特点：

- 集中配置所有路由
- 支持路由守卫/中间件
- 支持路由元信息（meta）
- 支持路由重定向
- 清晰的路由结构

## 3. 实现方案

Next.js 提供了两种路由系统，我们可以根据需求选择：

### 3.1 方案一：继续使用 App Router + 中间件

**优点**：
- 保持 Next.js 13+ 推荐的架构
- 无需大规模重构
- 支持 React Server Components

**实现步骤**：

1. **创建集中式路由配置文件**
2. **实现路由中间件**
3. **添加路由类型定义**
4. **修改现有页面组件**

### 3.2 方案二：切换到 Pages Router

**优点**：
- 更接近传统路由配置方式
- 支持 `next/router` 的编程式导航
- 适合习惯了传统路由的开发者

**实现步骤**：
1. **创建 pages/ 目录结构**
2. **创建集中式路由配置**
3. **实现路由组件**
4. **更新导航逻辑**

## 4. 方案一：App Router + 中间件 具体实现

### 4.1 创建路由配置文件

```typescript
// lib/routes.ts

export interface Route {
  path: string;
  name?: string;
  component: string; // 组件路径
  layout?: string;   // 布局组件路径
  meta?: {
    requiresAuth?: boolean;
    title?: string;
    [key: string]: any;
  };
  children?: Route[];
  redirect?: string;
}

export const routes: Route[] = [
  {
    path: '/',
    redirect: '/sentio'
  },
  {
    path: '/login',
    name: 'Login',
    component: './app/login/page.tsx',
    meta: {
      requiresAuth: false,
      title: '登录'
    }
  },
  {
    path: '/sentio',
    name: 'Sentio',
    component: './app/(products)/sentio/page.tsx',
    meta: {
      requiresAuth: true,
      title: 'Sentio'
    },
    children: [
      {
        path: '/sentio/settings',
        name: 'SentioSettings',
        component: './app/(products)/sentio/settings.tsx',
        meta: {
          requiresAuth: true,
          title: 'Sentio 设置'
        }
      }
    ]
  }
];
```

### 4.2 创建路由映射工具

```typescript
// lib/router.ts
import { routes } from './routes';

export function findRouteByPath(path: string): Route | undefined {
  // 扁平化路由数组
  const flatRoutes: Route[] = [];
  
  function flattenRoutes(routes: Route[]) {
    for (const route of routes) {
      flatRoutes.push(route);
      if (route.children) {
        flattenRoutes(route.children);
      }
    }
  }
  
  flattenRoutes(routes);
  return flatRoutes.find(route => route.path === path);
}

export function getRouteMeta(path: string) {
  const route = findRouteByPath(path);
  return route?.meta || {};
}
```

### 4.3 实现路由中间件

```typescript
// middleware.ts
import { NextResponse } from 'next/server';
import type { NextRequest } from 'next/server';
import { findRouteByPath } from './lib/router';

export function middleware(request: NextRequest) {
  const pathname = request.nextUrl.pathname;
  const route = findRouteByPath(pathname);
  
  // 处理重定向
  if (route?.redirect) {
    return NextResponse.redirect(new URL(route.redirect, request.url));
  }
  
  // 处理认证
  const isAuthenticated = request.cookies.get('auth_token')?.value;
  
  if (route?.meta?.requiresAuth && !isAuthenticated) {
    // 未认证，重定向到登录页
    const loginUrl = new URL('/login', request.url);
    loginUrl.searchParams.set('redirect', pathname);
    return NextResponse.redirect(loginUrl);
  }
  
  return NextResponse.next();
}

export const config = {
  matcher: ['/((?!api|_next/static|_next/image|favicon.ico).*)'],
};
```

### 4.4 更新布局组件

```typescript
// app/layout.tsx
import clsx from 'clsx';
import { Inter } from 'next/font/google';
import { NextIntlClientProvider } from 'next-intl';
import { getLocale, getMessages } from 'next-intl/server';
import { Providers } from './providers';
import { getSrcPath } from '@/lib/path';
import type { Metadata } from 'next';
import '@/styles/globals.css';
import { getRouteMeta } from '@/lib/router';

const inter = Inter({ subsets: ['latin'] });

export async function generateMetadata({ params, searchParams }: any) {
  // 获取当前路径
  const pathname = params?.path ? `/${params.path.join('/')}` : '/';
  const routeMeta = getRouteMeta(pathname);
  
  return {
    title: routeMeta.title || '颐养智伴',
    icons: 'favicon.icon',
  };
}

export default async function RootLayout({
  children,
}: Readonly<{
  children: React.ReactNode;
}>) {
  const locale = await getLocale();
  const messages = await getMessages();

  return (
    <html lang={locale} className='dark'>
      <head>
        <script src={getSrcPath('sentio/core/live2dcubismcore.min.js')} />
      </head>
      <body className={clsx(inter.className)}>
        <NextIntlClientProvider messages={messages}>
          <Providers>
            <main>
              {children}
            </main>
          </Providers>
        </NextIntlClientProvider>
      </body>
    </html>
  );
}
```

### 4.5 创建编程式导航工具

```typescript
// lib/navigation.ts
'use client';

import { useRouter } from 'next/navigation';

export function useAppRouter() {
  const router = useRouter();
  
  return {
    push: (path: string) => router.push(path),
    replace: (path: string) => router.replace(path),
    back: () => router.back(),
    forward: () => router.forward(),
    reload: () => router.refresh(),
  };
}
```

## 5. 方案二：切换到 Pages Router 具体实现

### 5.1 创建 pages/ 目录结构

```
pages/
├── _app.tsx            # 应用入口
├── _document.tsx       # 文档模板
├── index.tsx           # 主页
├── login.tsx           # 登录页
└── sentio/
    ├── index.tsx       # /sentio 页面
    └── settings.tsx    # /sentio/settings 页面
```

### 5.2 创建集中式路由配置

```typescript
// lib/routes.ts
import Login from '../pages/login';
import Sentio from '../pages/sentio';
import SentioSettings from '../pages/sentio/settings';

export interface Route {
  path: string;
  name?: string;
  component: React.ComponentType;
  meta?: {
    requiresAuth?: boolean;
    title?: string;
    [key: string]: any;
  };
  children?: Route[];
  redirect?: string;
}

export const routes: Route[] = [
  {
    path: '/',
    redirect: '/sentio'
  },
  {
    path: '/login',
    name: 'Login',
    component: Login,
    meta: {
      requiresAuth: false,
      title: '登录'
    }
  },
  {
    path: '/sentio',
    name: 'Sentio',
    component: Sentio,
    meta: {
      requiresAuth: true,
      title: 'Sentio'
    },
    children: [
      {
        path: '/sentio/settings',
        name: 'SentioSettings',
        component: SentioSettings,
        meta: {
          requiresAuth: true,
          title: 'Sentio 设置'
        }
      }
    ]
  }
];
```

### 5.3 更新 _app.tsx

```typescript
// pages/_app.tsx
import type { AppProps } from 'next/app';
import { useRouter } from 'next/router';
import { useEffect } from 'react';
import { routes } from '../lib/routes';
import '../styles/globals.css';

export default function App({ Component, pageProps }: AppProps) {
  const router = useRouter();
  
  useEffect(() => {
    // 处理路由元信息
    const pathname = router.pathname;
    const route = routes.find(r => r.path === pathname);
    
    if (route?.meta?.title) {
      document.title = route.meta.title;
    }
    
    // 处理认证
    const isAuthenticated = typeof window !== 'undefined' && localStorage.getItem('auth_token');
    
    if (route?.meta?.requiresAuth && !isAuthenticated) {
      router.push('/login');
    }
  }, [router.pathname]);
  
  return <Component {...pageProps} />;
}
```

### 5.4 创建主页组件

```typescript
// pages/index.tsx
import { useEffect } from 'react';
import { useRouter } from 'next/router';

export default function Home() {
  const router = useRouter();
  
  useEffect(() => {
    router.push('/sentio');
  }, []);
  
  return null;
}
```

### 5.5 创建登录页组件

```typescript
// pages/login.tsx
import LoginPage from '../app/login/login';

export default function Login() {
  return <LoginPage />;
}
```

### 5.6 创建 Sentio 页面

```typescript
// pages/sentio/index.tsx
import SentioPage from '../app/(products)/sentio/page';

export default function Sentio() {
  return <SentioPage />;
}
```

### 5.7 创建 Sentio Settings 页面

```typescript
// pages/sentio/settings.tsx
import SettingsPage from '../app/(products)/sentio/settings';

export default function SentioSettings() {
  return <SettingsPage />;
}
```

## 6. 两种方案对比

| 特性 | App Router + 中间件 | Pages Router |
|------|---------------------|--------------|
| **Next.js 版本支持** | Next.js 13+ | 所有 Next.js 版本 |
| **React Server Components** | ✅ 支持 | ❌ 不支持 |
| **集中式路由配置** | ✅ 支持 | ✅ 支持 |
| **路由守卫** | ✅ 通过中间件实现 | ✅ 通过 _app.tsx 实现 |
| **路由元信息** | ✅ 支持 | ✅ 支持 |
| **动态路由** | ✅ 支持 | ✅ 支持 |
| **重构工作量** | 小 | 大 |
| **官方推荐** | ✅ 推荐 | ❌ 不推荐 |

## 7. 推荐方案

**推荐使用方案一：App Router + 中间件**

原因：
1. 保持 Next.js 13+ 推荐的架构
2. 支持 React Server Components，有利于性能优化
3. 重构工作量小，不需要大规模修改现有代码
4. 中间件提供了强大的路由控制能力
5. 可以实现类似 Vue Router 的集中式路由管理

## 8. 实施建议

1. 先备份现有代码
2. 按照方案一逐步实施
3. 先实现路由配置文件和中间件
4. 然后更新布局组件和导航工具
5. 最后测试所有路由是否正常工作
6. 可以选择逐步迁移，先迁移部分路由，再迁移其他路由

## 9. 结论

Next.js 虽然推荐使用基于文件系统的 App Router，但通过合理的设计，我们可以实现类似 Vue Router 的集中式路由管理。使用 App Router + 中间件的方案既保持了 Next.js 13+ 的优势，又满足了集中式路由管理的需求。